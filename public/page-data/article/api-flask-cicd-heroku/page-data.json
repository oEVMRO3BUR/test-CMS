{"componentChunkName":"component---src-templates-article-js","path":"/article/api-flask-cicd-heroku","webpackCompilationHash":"","result":{"data":{"article":{"frontmatter":{"title":"How do you do, fellow kids?","author":"Matthieu","excerpt":"Mettre en production rapidement une API Flask avec Gitlab et Heroku","date":"06/11/2019","tags":["Python"],"illustration":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABTK9IqoqE/wD/xAAcEAABAwUAAAAAAAAAAAAAAAABAAIDEBIhMkL/2gAIAQEAAQUCl35wjc6Ugin/xAAWEQADAAAAAAAAAAAAAAAAAAAQITL/2gAIAQMBAT8BlD//xAAVEQEBAAAAAAAAAAAAAAAAAAAQMf/aAAgBAgEBPwGn/8QAGRAAAwADAAAAAAAAAAAAAAAAARAhADHh/9oACAEBAAY/AuO6wmL/xAAaEAACAwEBAAAAAAAAAAAAAAABEQAhMYFR/9oACAEBAAE/IXw+aiVoAWlchoYGhBHgjJsq5//aAAwDAQACAAMAAAAQa+//xAAYEQEAAwEAAAAAAAAAAAAAAAABABEhUf/aAAgBAwEBPxAKHUcan//EABcRAQADAAAAAAAAAAAAAAAAAAABEWH/2gAIAQIBAT8QnS3/xAAcEAEAAwEAAwEAAAAAAAAAAAABABEhQVFhsdH/2gAIAQEAAT8QZLU50fW+H7BOUG8MhlqvGoy5uzDYWCjqn4QEAEXiT//Z","aspectRatio":1.25,"src":"/static/5379c093b15c3943a5daae07cd193f58/bc3a8/cover.jpg","srcSet":"/static/5379c093b15c3943a5daae07cd193f58/d278e/cover.jpg 200w,\n/static/5379c093b15c3943a5daae07cd193f58/8539d/cover.jpg 400w,\n/static/5379c093b15c3943a5daae07cd193f58/bc3a8/cover.jpg 800w,\n/static/5379c093b15c3943a5daae07cd193f58/2b1a3/cover.jpg 900w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"API Flask en croute de CI/CD Gitlab, accompagnée de son déploiement sur Heroku."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Ou comment être confronté, à 40 ans, sans avoir fait de dev depuis la version 1.5 de Python, à une problématique de déploiement en prod d'une demo, lors d'un Hackhaton Ethereum, rempli de dev à capuches allemands et russes."}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/5379c093b15c3943a5daae07cd193f58/2d017/fellowkids__01.jpg","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABTK9IqoqE/wD/xAAcEAABAwUAAAAAAAAAAAAAAAABAAIDEBIhMkL/2gAIAQEAAQUCl35wjc6Ugin/xAAWEQADAAAAAAAAAAAAAAAAAAAQITL/2gAIAQMBAT8BlD//xAAVEQEBAAAAAAAAAAAAAAAAAAAQMf/aAAgBAgEBPwGn/8QAGRAAAwADAAAAAAAAAAAAAAAAARAhADHh/9oACAEBAAY/AuO6wmL/xAAaEAACAwEBAAAAAAAAAAAAAAABEQAhMYFR/9oACAEBAAE/IXw+aiVoAWlchoYGhBHgjJsq5//aAAwDAQACAAMAAAAQa+//xAAYEQEAAwEAAAAAAAAAAAAAAAABABEhUf/aAAgBAwEBPxAKHUcan//EABcRAQADAAAAAAAAAAAAAAAAAAABEWH/2gAIAQIBAT8QnS3/xAAcEAEAAwEAAwEAAAAAAAAAAAABABEhQVFhsdH/2gAIAQEAAT8QZLU50fW+H7BOUG8MhlqvGoy5uzDYWCjqn4QEAEXiT//Z'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"fellowkids  01","title":"fellowkids  01","src":"/static/5379c093b15c3943a5daae07cd193f58/67d4f/fellowkids__01.jpg","srcSet":["/static/5379c093b15c3943a5daae07cd193f58/3cfb5/fellowkids__01.jpg 175w","/static/5379c093b15c3943a5daae07cd193f58/3a2a3/fellowkids__01.jpg 350w","/static/5379c093b15c3943a5daae07cd193f58/67d4f/fellowkids__01.jpg 700w","/static/5379c093b15c3943a5daae07cd193f58/2d017/fellowkids__01.jpg 900w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"1. Un Hackathon compliqué"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tout part du hackathon EthParis 2019.\nForcément, quand on me prend par les sentiments en me disant \"Non mais viens, ça va être cool, on va apprendre plein de choses, pas grave si ton niveau en dev est nul, tu auras toujours quelque chose à faire, et puis, tu arrives sur tes 40 ans, faut que tu fasses ça avant\".\nMouais.\nFaire une petite API, quick and dirty, en local, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"pas de soucis"}]},{"type":"text","value":", mais apprendre la CI/CD de Gitlab et les déploiements sur Heroku en 2h, entouré de hackers allemands, ce n'est pas tout à fait "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"la même chose"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pourquoi cet article ?\nTout simplement, parce que, sous stress, après 1 litre de RedBull, j'aurais aimé trouver exactement ce qui va suivre. (Bon après j'ai certainement mal cherché, Dieu Google et les anges de la Documentation (avec une majuscule de respect) ont en général toujours les réponses à nos interrogations)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bref."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Objectif"}]},{"type":"text","value":" : avoir une brique de base d’une API Flask hébergée en production (via "},{"type":"element","tagName":"a","properties":{"href":"https://heroku.com"},"children":[{"type":"text","value":"Heroku"}]},{"type":"text","value":") avec base de données et avec une CI (via "},{"type":"element","tagName":"a","properties":{"href":"https://gitlab.com"},"children":[{"type":"text","value":"Gitlab"}]},{"type":"text","value":")."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"2. Le projet"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour appliquer, une simple API qui permet d'ajouter des titres de musique à une liste (on pourrait appeler ça une "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"playlist"}]},{"type":"text","value":", car c'est une liste de titres à jouer, futé), faite avec Flask et une persistence des données sur une base Posgresql.\nRien de compliqué avec juste 3 routes."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Le code est disponible "},{"type":"element","tagName":"a","properties":{"href":"https://gitlab.com/MatthieuCoddity/songlist_base"},"children":[{"type":"text","value":"ici"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pré-requis (ultra obvious) :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Python 3.6 installé"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"PostgreSQL installé"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Un compte Gitlab avec un repo vide"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Un compte Heroku"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ce qui va suivre a été fait et testé sous Macintosh OS Mojave 10.14.6, des différences peuvent subsister sous Windows (certainement) ou Linux (peu)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"3. Déploiement en local"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Le projet utilise :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"http://flask.palletsprojects.com/en/1.1.x/"},"children":[{"type":"text","value":"Flask"}]},{"type":"text","value":" (of course) microframework web en python"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Flask-script pour le lancement des tests, la migration de bdd et le lancement de l'app"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Gunicorn pour le serveur en production"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Unittest pour les tests unitaires "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Autoenv pour le lancement automatique de l'environnement virtuel et la gestion des variables d'environnement"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.sqlalchemy.org/en/13/"},"children":[{"type":"text","value":"SQLalchemy"}]},{"type":"text","value":" et "},{"type":"element","tagName":"a","properties":{"href":"http://initd.org/psycopg/"},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" pour la connexion à la DB"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Le projet utilise une persistance des données sur une base PostgreSQL, donc la première action à faire est de créer 2 bases sur votre machine, l'une de dev et l'une de test :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ psql\n# create database songlist;\nCREATE DATABASE\n# create database songlist_test;\nCREATE DATABASE\n# quit"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour lancer le projet, après clonage, placez-vous dans le répertoire et créez un env virtuel Python puis activez le :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ python3 -m venv env\n$ source env/bin/activate"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Maintenant, installation des packages contenus dans le "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"requirements.txt"}]},{"type":"text","value":" :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ pip install --upgrade pip\n$ pip install -r requirements.txt"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Il est possible d'avoir une "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"erreur"}]},{"type":"text","value":" à l'installation de "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" si vous n'êtes pas sous Mac, car ici nous utilisons les binaires du package psycopg2. Si c'est le cas, utilisez le package "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" en remplaçant la ligne dans le "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"requirements.txt"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"C'est au tour de l'utilisation d'Autoenv! Créez un fichier "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":".env"}]},{"type":"text","value":" à la racine du projet et ajoutez les lignes suivantes :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"source env/bin/activate\nexport APP_SETTINGS=\"core.server.config.DevelopmentConfig\"\nexport SECRET_KEY=\"UnePhraseSecreteBadass\"\nexport DATABASE_URI=\"postgresql://postgres:@localhost/songlist\"\nexport DATABASE_URI_TEST=\"postgresql://postgres:@localhost/songlist_test\""}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"et ensuite l'ajouter au path :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ echo \"source `which activate.sh`\" >> ~/.bashrc\n$ source ~/.bashrc"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":" Avec "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Autoenv"}]},{"type":"text","value":", un "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"cd"}]},{"type":"text","value":" dans le repertoire va lancer automatiquement le script "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":".env"}]},{"type":"text","value":" qui va activer l'environnement virtuel, et renseigner les variables d'environnement en local (mais pas que, on verra ça plus tard).\nPuisque vous avez déjà activé votre "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"venv"}]},{"type":"text","value":" Python, un simple "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ source .env"}]},{"type":"text","value":" suffira.\nAutoenv n'est vraiment pas indispensable, un simple script bash pourrait suffire."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Le sujet n'est pas le projet Flask en tant que tel, alors, si c'est la première fois que vous en approchez un, voilà ce qu'il y a à savoir :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Le module "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"core"}]},{"type":"text","value":" comprend les modules "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"core.server"}]},{"type":"text","value":" (votre app) et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"core.tests"}]},{"type":"text","value":" (les... tests unitaires)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Plusieurs configurations sont prévues : développement, test et production décrites dans le module "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"core.server.config"}]},{"type":"text","value":". La config sera utilisée via la variable d'environnement "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"APP_SETTINGS"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"SECRET_KEY"}]},{"type":"text","value":" est la clef de sécurité de votre app Flask."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"DATABASE_URI"}]},{"type":"text","value":" surprise, c'est votre base en local (et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"_TEST"}]},{"type":"text","value":", celle de test)."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":" Attention, en fonction des environnements, si vous avez spécifié un mot de passe à votre base PostgreSQL, pensez à ajouter votre login:password aux URI "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"DATABASE_URI"}]},{"type":"text","value":" et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"DATABASE_URI_TEST"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nous utilisons ici flask-script qui va permettre de manager le lancement des tests, la création, la migration et l'upgrade de la base, et le lancement du serveur.\nCommencez par la base de données :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"(env)$ python manage.py db init\n(env)$ python manage.py db migrate\n(env)$ python manage.py db upgrade"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour le lancement des tests unitaires, c'est très simple :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"(env)$ python manage.py test\n\ntest_app_is_development (test_config.TestDevelopmentConfig) ... ok\ntest_app_is_production (test_config.TestProductionConfig) ... ok\ntest_app_is_testing (test_config.TestTestingConfig) ... ok\ntest_add_new_song (test_routes.TestRoutes)\ntest_for_adding_a_song ... ok\ntest_add_song_already_added (test_routes.TestRoutes)\ntest_for_adding_an_already_added_song ... ok\ntest_clear (test_routes.TestRoutes)\ntest_for_get_all_songs ... ok\ntest_getall (test_routes.TestRoutes)\ntest_for_get_all_songs ... ok\ntest_getall_emptylist (test_routes.TestRoutes)\ntest_for_get_all_songs_with_empty_list ... ok\n\n----------------------------------------------------------------------\nRan 8 tests in 0.250s\n\nOK"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour le lancement du serveur en local :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"(env)$ python manage.py runserver"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Votre app peut être testée sur le port 5000 de votre environnement avec Postman/curl:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ curl -X POST -H \"Content-Type: application/json\" -d '{\"title\": \"Atomic - Blondie\",\"year\" : 1979}' http://localhost:5000/add\n$ curl http://localhost:5000/getlist\n$ curl -X DELETE http://localhost:5000/clear"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Maintenant, passons aux choses sérieuses."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"4. Gitlab-CI"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Gitlab offre des outils de CI/CD, et ce, même pour des comptes freemium.\nVotre pipeline CI/CD est défini dans un fichier "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"gitlab-ci.yml"}]},{"type":"text","value":" à la racine de votre projet, celui-ci va contenir les instructions qui vont être exécutées par le "},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/runner/"},"children":[{"type":"text","value":"Gitlab Runner"}]},{"type":"text","value":", avec éventuellement des instructions conditionnelles lors de l'échec ou le succès d'un "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"job"}]},{"type":"text","value":".\nLes jobs justement, que sont-ils ?\nEh bien ce sont les différentes instructions ou tâches qui vont être exécutées par le Runner."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Job1:\n    type: type de job\n    service: \n    - image Docker utilisée par le script (comme par exemple une db)\n    variables:\n    - variable1 (qui va etre utilisée par le service au-dessus) \n    - variable2\n    script:\n    - tâche1\n\t- tâche2\n    - tâche3\n Job2:\n \ttype: type de job\n    script:\n    - tâche1\n\t- tâche2\n    - tâche3"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour chaque tâche, vous pouvez définir les paramètres qui vont modifier son comportement."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"script"}]},{"type":"text","value":" (surprise) va définir le script à exécuter"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":"/"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"after_script"}]},{"type":"text","value":" va définir des instructions à exécuter (surprise) avant ou après l'exécution de la tâche"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"service"}]},{"type":"text","value":" définit l'utilisation de conteneurs Docker"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"only"}]},{"type":"text","value":"/"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"except"}]},{"type":"text","value":" limitation sur le lancement ou non de la tâche"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"La liste des paramètres est assez "},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/ci/yaml/#configuration-parameters"},"children":[{"type":"text","value":"longue"}]},{"type":"text","value":" avec de quoi s'amuser."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Au sujet des variables"}]},{"type":"text","value":"\nLes tâches peuvent évidemment accéder à des variables d'environnement.\nCelles-ci peuvent être déclarées via l'UI web "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Settings > CI/CD"}]},{"type":"text","value":" ou via le fichier "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"gitlab-ci.yml"}]},{"type":"text","value":" directement.\nUn "},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html"},"children":[{"type":"text","value":"certain nombre"}]},{"type":"text","value":" de variables prédéfinies sont disponibles directement.\nC'est via ces variables d'environnement que vous allez pouvoir saisir les clefs d'API d'Heroku et les valeurs de configuration de l'application. "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour notre projet, le fichier "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" contiendra 3 jobs : "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"test"}]},{"type":"text","value":" pour les tests (étonnant) lancés à chaque commit"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"staging"}]},{"type":"text","value":" pour une pre prod sur une instance Heroku pour chaque commit sur master"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"prod"}]},{"type":"text","value":" pour une prod sur une instance Heroku dès que la branche master est taggée"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Prêts ? C'est parti, créez un fichier "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" à la racine et ajoutez les différents jobs ci-dessous."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Le job de test"}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"test:\n  services:\n  - postgres:latest\n  variables:\n    POSTGRES_DB: songlist_test\n    POSTGRES_USER: runner\n    POSTGRES_PASSWORD: \"pass\"\n  script:\n  - apt-get update -qy\n  - apt-get install -y python-dev python-pip\n  - pip install -r requirements.txt\n  - export SECRET_KEY=\"UnePhraseSecreteBadass\"\n  - export DATABASE_URI=\"postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/songlist_test\"\n  - export DATABASE_URI_TEST=\"postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/songlist_test\"\n  - export APP_SETTINGS=\"core.server.config.TestingConfig\"\n  - python manage.py test"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Premier point, Gitlab va utiliser une image PostgreSQL pour l'exécution des tests via le service donné (postgres) et définir les variables de ce service : nom de la db, user et password."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour chaque commit, Gitlab va exécuter le script défini, soit :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"créer un conteneur dans lequel il va installer un environnement python "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"installer les paquets du projet contenu dans le "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"requirements.txt"}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"définir les variables d'environnement propre à celui de Gitlab ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"SECRET_KEY"}]},{"type":"text","value":" et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"APP_SETTINGS"}]},{"type":"text","value":")"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"définir l'URI de la base testée ici"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"exécuter les tests par la commande\n"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"python manage.py test"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"On y va ?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ git add .\n$ git commit -m \"ajout gitlabci\"\n$ git push origin master "}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"En principe, vous devriez voir le succès du job :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/100234bfe292f08fbcf42174f6689219/57e65/pipeline_test.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAaUlEQVQI102MwQqAMAxD/f//8Rc8e/MoHt1UrJsrbnXRdQimhJSWvKafBth1QZFzBBFRGzNj3XYYYnAU/V8Ske6653c0c01mBhGhaccOezj06L1TWEpRgcZauJNxl1L+AXMFfS4KISjwAfkIm2oQVpiKAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"pipeline test","title":"pipeline test","src":"/static/100234bfe292f08fbcf42174f6689219/a8200/pipeline_test.png","srcSet":["/static/100234bfe292f08fbcf42174f6689219/52d5c/pipeline_test.png 175w","/static/100234bfe292f08fbcf42174f6689219/1bae2/pipeline_test.png 350w","/static/100234bfe292f08fbcf42174f6689219/a8200/pipeline_test.png 700w","/static/100234bfe292f08fbcf42174f6689219/0ab52/pipeline_test.png 1050w","/static/100234bfe292f08fbcf42174f6689219/fa92b/pipeline_test.png 1400w","/static/100234bfe292f08fbcf42174f6689219/57e65/pipeline_test.png 2050w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"   "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Les plus perspicaces auront noté que je n'ai ici créé qu'une seule branche, master, ce qui est bien sûr une mauvaise pratique. Vous pouvez spécifier le déroulement des jobs sur une branche précise avec le paramètre "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"only"}]},{"type":"text","value":" si le coeur vous en dit, tel que c'est fait ci-dessous avec les jobs de staging et de prod."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":" "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Le job de staging"}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"staging:\n  type: deploy\n  script:\n  - apt-get update -qy\n  - apt-get install -y ruby-dev\n  - gem install dpl\n  - dpl --provider=heroku --app=votre_nom_app_staging --api_key=$HEROKU_STAGING_API_kEY\n  only:\n  - master"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour chaque commit sur la branche master, spécifié par le paramètre "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"only"}]},{"type":"text","value":", Gitlab va dérouler, après le job de test, son script Ruby de déploiement "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dpl"}]},{"type":"text","value":" avec les paramètres suivants:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"provider"}]},{"type":"text","value":" ici Heroku, si vous avez bien suivi"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":" le nom de votre app en staging chez votre provider"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"api_key"}]},{"type":"text","value":" la clef qui va permettre à Heroku d'autoriser le déploiement par Gitlab sur cette app (on voit ça après)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Le job de production"}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"production\n  type: deploy\n  script:\n  - apt-get update -qy\n  - apt-get install -y ruby-dev\n  - gem install dpl\n  - dpl --provider=heroku --app=votre_nom_app --api_key=$HEROKU_PROD_API_kEY\n  only:\n  - tags"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour chaque version taggée, spécifiée par le paramètre "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"only"}]},{"type":"text","value":", Gitlab va dérouler, après le job de test, son script Ruby de déploiement "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dpl"}]},{"type":"text","value":" avec les paramètres différents :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"provider"}]},{"type":"text","value":" toujours Heroku"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":" le nom de votre app de prod chez votre provider"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"api_key"}]},{"type":"text","value":" la clef qui va permettre à Heroku d'autoriser le déploiement par Gitlab sur cette app (on voit ça juste après)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Voilà pour le rapide tour d'horizon du démarrage d'une CI/CD avec Gitlab, qui peut/doit être complétée par les outils disponibles sur la plateforme :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/ci/caching/"},"children":[{"type":"text","value":"Caching"}]},{"type":"text","value":" qui permet d'économiser du temps en gardant du contenu de jobs déjà réalisés"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/topics/autodevops/"},"children":[{"type":"text","value":"Auto DevOps"}]},{"type":"text","value":" qui offre un panel de fonctionnalités DevOps du building au monitoring"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/ci/chatops/README.html"},"children":[{"type":"text","value":"Chat Ops"}]},{"type":"text","value":" qui permet aux jobs d'interagir avec des canaux de chat comme Slack"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Ou encore une intégration de "},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/ci/docker/README.html"},"children":[{"type":"text","value":"Docker"}]},{"type":"text","value":" bien pratique"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Avancement et historiques des pipelines sont consultables depuis l’interface Web (ma passion : regarder les pipelines et jobs se dérouler et... échouer. Note : pensez à désactiver les notifications mail !)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"5. Heroku"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour ceux qui ne connaissent pas, Heroku est une entreprise US de PaaS, Plateform as a Service, qui fournit comme son nom l'indique une plateforme de production clef en main. Heroku présente pour moi beaucoup d'avantages quand on veut rapidement mettre en production son app : pas de configuration longue comme dans le cas d'un serveur dédié ou de migraine à force de lire le catalogue AWS avant de pouvoir choisir le service qui va bien.\nEn plus de ça, le compte gratuit permet de bien s'amuser déjà, et votre plateforme est facilement scalable."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Dans la pratique, Heroku va permettre de créer un pipeline de déploiement automatisé (pré-prod, prod) connecté à votre logiciel de versionning.\nUne fonctionnalité offerte bien sympa (mais non présentée ici) est le principe de "},{"type":"element","tagName":"a","properties":{"href":"https://devcenter.heroku.com/articles/github-integration-review-apps"},"children":[{"type":"text","value":"Review Apps"}]},{"type":"text","value":". A chaque pull request, une Heroku app va être créée et va permettre de tester la PR en prod.\nHeroku peut héberger des applications des principaux langages et framework actuels : Node.js, Ruby, Java, PHP, Python, Go, Scala, Clojure.\nEt olive du vodka martini : la "},{"type":"element","tagName":"a","properties":{"href":"https://devcenter.heroku.com/"},"children":[{"type":"text","value":"documentation"}]},{"type":"text","value":" est "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"très"}]},{"type":"text","value":" complète. "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"La première étape est l'installation du "},{"type":"element","tagName":"a","properties":{"href":"https://devcenter.heroku.com/articles/heroku-cli"},"children":[{"type":"text","value":"CLI"}]},{"type":"text","value":" qui vous permettra de jouer avec Heroku directement depuis la console (après avoir créé un compte) :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku login"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Maintenant, si vous avez bien suivi, vous devez créer 2 instances, staging et prod, soit 2 apps qui vont s'appeler "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"votre_nom_app_staging"}]},{"type":"text","value":" et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"votre_nom_app"}]},{"type":"text","value":", et qui vont constituer votre "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"pipeline"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku create votre_nom_app\n$ heroku create votre_nom_app_staging\n$ heroku pipelines:create songlist --app=votre_nom_app"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Heroku va vous inviter à choisir dev, staging ou prod pour l'app "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"votre_nom_app"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"? Stage of votre_nom_app (Use arrow keys)\ndevelopment\nstaging \n❯ production"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Et maintenant, ajouter "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"votre_nom_app_staging"}]},{"type":"text","value":" au pipeline comme app de "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"staging"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku pipelines:add songlist -a votre_nom_app_staging"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bravo votre pipeline est prêt, il ne reste plus qu'à lier Gitlab et Heroku."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/c7e7208f6663e0d5ea6122fe563f0be7/9bd9b/heroku_pipeline.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 20.932878270762227%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApUlEQVQY02WQiQ4CIQxE9///1KgslKMcZccW1MRI8qDQYdL2yKXBhYRIFcEzahMU7j+Y5qQMTwUUGP4s4Dr+dMaRc8PjFuFDhHMBFBNkXpjGtc/WBc970jzBnQGt9vUuc26NMsbchrZx6aBTK3BpMdTAPmViFcoybFqRaDxEcKmBLZGJHOvSfg1ZL4ZV+qGUdwulr9YsX9vYxjoSi43Vtmm4f0fwAuh1N9UmwuedAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"heroku pipeline","title":"heroku pipeline","src":"/static/c7e7208f6663e0d5ea6122fe563f0be7/a8200/heroku_pipeline.png","srcSet":["/static/c7e7208f6663e0d5ea6122fe563f0be7/52d5c/heroku_pipeline.png 175w","/static/c7e7208f6663e0d5ea6122fe563f0be7/1bae2/heroku_pipeline.png 350w","/static/c7e7208f6663e0d5ea6122fe563f0be7/a8200/heroku_pipeline.png 700w","/static/c7e7208f6663e0d5ea6122fe563f0be7/0ab52/heroku_pipeline.png 1050w","/static/c7e7208f6663e0d5ea6122fe563f0be7/fa92b/heroku_pipeline.png 1400w","/static/c7e7208f6663e0d5ea6122fe563f0be7/9bd9b/heroku_pipeline.png 1758w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Vous vous souvenez que dans le "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"gitlab-ci.yml"}]},{"type":"text","value":", vous aviez indiqué deux clefs d'API "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"HEROKU_PROD_API_KEY"}]},{"type":"text","value":" et "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"HEROKU_STAGING_API_KEY"}]},{"type":"text","value":", la valeur est à récupérer sur l'UI Heroku "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"manage account>API Key"}]},{"type":"text","value":" et à déclarer sur Gitlab "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Settings > CI/CD > Variables"}]},{"type":"text","value":" pour chacune des clefs."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"API Key :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/30022354f7e91672eb7928c817a16f9f/226ea/heroku_token.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 12.123493975903616%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAW0lEQVQI11WMsQ6AMAhE+/8/5Q+4OdrFse5NkRZOaIqJF0jgeEcSUXQemFK10jUqqDFqJRAxxpDZcQ/G5X6rD9R+JTf9qS4gIDEoHwX7lnGd9xcM5sdanqnP/QXjjZ04TcuxaAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"heroku token","title":"heroku token","src":"/static/30022354f7e91672eb7928c817a16f9f/a8200/heroku_token.png","srcSet":["/static/30022354f7e91672eb7928c817a16f9f/52d5c/heroku_token.png 175w","/static/30022354f7e91672eb7928c817a16f9f/1bae2/heroku_token.png 350w","/static/30022354f7e91672eb7928c817a16f9f/a8200/heroku_token.png 700w","/static/30022354f7e91672eb7928c817a16f9f/0ab52/heroku_token.png 1050w","/static/30022354f7e91672eb7928c817a16f9f/fa92b/heroku_token.png 1400w","/static/30022354f7e91672eb7928c817a16f9f/226ea/heroku_token.png 2656w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Champs Gitlab :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/a4d60499d42a51271502ccbeeec517a8/e3ed7/gitlab_tokens.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 35.947712418300654%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABDElEQVQoz4WQSXLEIAxFff+zZJ9t9jlEl90GzxNg8MiPpG67skqoUoGkryeJxFqLEAK2bcN5nmQRXddiMhbrukqO43+d4zhExyfp+x4MvYAxRmitkBc1xZ3kfpsx5nWTTfT2fpa6ZVleQGMmcRjIME4WRSHQLMvo1kjTFHme3z7fTfqAVhq67hDfk3J9kmUlrdjDOSujc/Ca2Dknq8zzLE0dxcdxlPzQtgg+wJKGc1ctARWqqhLhvu/SaSHhsR8CdO8C772Ay7KUJg0BGcxx1nCtAJ9PJSsOw3ADG9NjCg4+LGIMvKD85wxkPfuXMUyASlU0YU1rdzLVEU98PL7wmX0jbVd0br//57/Dmh/7NRyKNVfz3QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"gitlab tokens","title":"gitlab tokens","src":"/static/a4d60499d42a51271502ccbeeec517a8/a8200/gitlab_tokens.png","srcSet":["/static/a4d60499d42a51271502ccbeeec517a8/52d5c/gitlab_tokens.png 175w","/static/a4d60499d42a51271502ccbeeec517a8/1bae2/gitlab_tokens.png 350w","/static/a4d60499d42a51271502ccbeeec517a8/a8200/gitlab_tokens.png 700w","/static/a4d60499d42a51271502ccbeeec517a8/0ab52/gitlab_tokens.png 1050w","/static/a4d60499d42a51271502ccbeeec517a8/fa92b/gitlab_tokens.png 1400w","/static/a4d60499d42a51271502ccbeeec517a8/e3ed7/gitlab_tokens.png 2754w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"En voiture Simone (yeah), Gitlab sera maintenant authentifié sur Heroku."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 560px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/5905f0608081344e5e7a52d046024b1a/ae25f/nina_simone.jpg","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDAQX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG8sQ6wwf/EABoQAAIDAQEAAAAAAAAAAAAAAAECAAMEETP/2gAIAQEAAQUCtYJViKwrNXllHLp//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAQUBAAAAAAAAAAAAAAAAAQACEBFxgf/aAAgBAQAGPwIk4nNqo6tbH//EAB0QAQABAwUAAAAAAAAAAAAAAAEAESFBEDFhcZH/2gAIAQEAAT8hARRw5iAUii3ly02esAaZK+6f/9oADAMBAAIAAwAAABAQD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAIDAQEAAAAAAAAAAAAAAAERACExQfD/2gAIAQEAAT8QHDyho8bBS6eYGlQ5LPJmL3cQlNW0gIdn/9k='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"nina simone","title":"nina simone","src":"/static/5905f0608081344e5e7a52d046024b1a/ae25f/nina_simone.jpg","srcSet":["/static/5905f0608081344e5e7a52d046024b1a/3cfb5/nina_simone.jpg 175w","/static/5905f0608081344e5e7a52d046024b1a/3a2a3/nina_simone.jpg 350w","/static/5905f0608081344e5e7a52d046024b1a/ae25f/nina_simone.jpg 560w"],"sizes":["(max-width:","560px)","100vw,","560px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour paramétrer votre app pour le staging et la prod, il suffit d'ajouter les commandes suivantes via le CLI Heroku (et/ou les ajouter directement dans le "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":".env"}]},{"type":"text","value":") :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"heroku config:set APP_SETTINGS=\"core.server.config.ProductionConfig\" --app votre_nom_app_staging\nheroku config:set APP_SETTINGS=\"core.server.config.ProductionConfig\" --app votre_nom_app\nheroku config:set SECRET_KEY=\"UnePhraseSecreteBadass\" --app votre_nom_app\nheroku config:set SECRET_KEY=\"UnePhraseSecreteBadass\" --app votre_nom_app_staging"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Il ne manque rien ?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Si ! Les bases de données.\nHeroku propose des bases "},{"type":"element","tagName":"a","properties":{"href":"https://www.heroku.com/postgres"},"children":[{"type":"text","value":"Postgresql managés"}]},{"type":"text","value":", avec des versions gratuites (hobby-dev), que nous allons utiliser ici.\nHeroku va instancier 2 bases, et vous donner les credentials permettant de les connecter à vos apps."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":" Elles sont créées avec le CLI Heroku, une pour le staging, une pour la prod : "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku addons:create heroku-postgresql:hobby-dev -a votre_nom_app_staging\n$ heroku addons:create heroku-postgresql:hobby-dev -a votre_nom_app"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Une fois les bases créées, récuperez les credentials sur l'UI d'Heroku pour chaque app, et déclarez les URI des bases via le CLI (et/ou les ajouter directement dans le "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":".env"}]},{"type":"text","value":") :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/cf31ac96f01099db3babf2b44e86625e/ed731/credentials_db.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 84.66557911908646%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABzklEQVQ4y5VU2W7DMAzL/39hH4qi953bSXzE4URtDtI9LFgAVipj0xKtNnM+oB8cxhjhJe96iyj5YByaskMcJbdOAUxYezIfRhEaEWSjDxHWBTiBaS2aeoC1QTlC164gs85LVYNUaRVOvsdpmmvR/AcxriNrTYdXXqCsGxRVDdN1KjQthLDMV1tmS8Yj2BG28+rdFP/euDzsN7K27ZHntaBCWbaoKgNjevRiAyPtINhJ0xrxevxTNHPei+G8RYthGBTfYp1GhXC0gtxa29nr9cL1esX9fte42+1wOByw3W6x3+9xPB4V5E+nkxzQycW5+XD7Uwg55lnTNNJqiff7rTHPc/CQxBVFMed8x1hVlXIE3z8ej3lNxjIpYIz5MJ0LkwA3MD6fz5lnTq7v+8+W+cENm80GdV0rOYrxt9sN5/NZI0V4CHn+iohl/nEpFGC5bD09XMwKErxc3Nq4fAiyApqaNiVBmh1CwH8eFaQXl8tFBVKF5Nq2RSfjQivYAb8z0m/my0ie61QwjQyvfekhD+GocHwYCY4QvSXH8SLSaDGfK+RJ9Or7TyB+jFEamWVOS9KIkUu8CrJcVkgiCbJ8epuE02yS4xzyPcE8reP+L7ZiJVM74Y/pAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"credentials db","title":"credentials db","src":"/static/cf31ac96f01099db3babf2b44e86625e/a8200/credentials_db.png","srcSet":["/static/cf31ac96f01099db3babf2b44e86625e/52d5c/credentials_db.png 175w","/static/cf31ac96f01099db3babf2b44e86625e/1bae2/credentials_db.png 350w","/static/cf31ac96f01099db3babf2b44e86625e/a8200/credentials_db.png 700w","/static/cf31ac96f01099db3babf2b44e86625e/0ab52/credentials_db.png 1050w","/static/cf31ac96f01099db3babf2b44e86625e/ed731/credentials_db.png 1226w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku config:set DATABASE_URI=\"postgres://URI_FOURNIE_PAR_HEROKU_POUR_BASE_STAGING\" -a votre_nom_app_staging\n$ heroku config:set DATABASE_URI=\"postgres://URI_FOURNIE_PAR_HEROKU_POUR_BASE_PROD\" -a votre_nom_app    "}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pour résumer, vous avez votre pipeline de déploiement créé avec une app de staging et une app de prod, avec pour chacune une base Posgre attachée, avec une configuration de production."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Manque maintenant une chose, le fichier qui va contenir les scripts d'exécution sur Heroku, nommé "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Procfile"}]},{"type":"text","value":" (sans extension et avec une majuscule - important).\nCréez-le à la racine du projet et ajoutez les lignes suivantes : "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"web: gunicorn core.server:app\nupgrade: python manage.py db upgrade"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Heroku va créer une \"Dyno\", un conteneur contenant votre application, sur lequel vous allez pouvoir jouer avec 3 process :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" : qui sera lancé automatiquement et qui va lancer votre app avec\nun serveur web Gunicorn  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"upgrade"}]},{"type":"text","value":" : qui va vous permettre\nde réaliser les migrations et upgrade de la base."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Testons tout ça."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ git add .\n$ git commit -m \"initial commit\"\n$ git push origin master"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Gardez un oeil sur le déroulement des tests et le lancement des jobs via l'UI de Gitlab (section CI/CD de votre projet).\nEn principe, vous devriez voir ceci :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/202a7dd15ed4516628f7554f6bbcdb8d/2eeef/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 8.49740932642487%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcUlEQVQI11WMMQ6DMBAE+f97+EJekCpVpFS2EcY67jA+zt6ARcNK2+xoZ1A78P594KeAK+tKsHMzM3jvsKQEFxmStfNyMtGM1tqjtVaICIbdCsbvCzOnfmCmLrukPjjEuCBMM7a830IF6/aQ9b0UEBH+6+ybGaS7waEAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Capture d  cran 2019 11 01   14 46 33","title":"Capture d  cran 2019 11 01   14 46 33","src":"/static/202a7dd15ed4516628f7554f6bbcdb8d/a8200/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png","srcSet":["/static/202a7dd15ed4516628f7554f6bbcdb8d/52d5c/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png 175w","/static/202a7dd15ed4516628f7554f6bbcdb8d/1bae2/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png 350w","/static/202a7dd15ed4516628f7554f6bbcdb8d/a8200/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png 700w","/static/202a7dd15ed4516628f7554f6bbcdb8d/0ab52/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png 1050w","/static/202a7dd15ed4516628f7554f6bbcdb8d/fa92b/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png 1400w","/static/202a7dd15ed4516628f7554f6bbcdb8d/2eeef/Capture%20d%E2%80%99%C3%A9cran%202019-11-01%20%C3%A0%2014.46.33.png 1930w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"  "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Vous pouvez passer à l'upgrade de votre base sur Heroku :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku run upgrade --app votre_nom_app_staging"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Testez sur "},{"type":"element","tagName":"a","properties":{"href":"https://votre_nom_app_staging.herokuapp.com"},"children":[{"type":"text","value":"https://votre_nom_app_staging.herokuapp.com"}]},{"type":"text","value":" avec Postman ou un Curl les différentes routes : "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"/add"}]},{"type":"text","value":", "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"/getlist"}]},{"type":"text","value":", et "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"/clear"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tout est bon ? Alors, on tag."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ git tag -a v1.0 -m \"v1.0\"\n$ git push origin v1.0"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 700px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/21a745cd322d080bd16b77635cf63dcc/337cb/gitlab_pipeline.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 12.315270935960593%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAZklEQVQI1x2NBwoDMQwE7/9PDXGLreqyOUswLKiMnp8TvtKw90bvPRgvJA62BZwDIoq+mmKtBWaGmUWKCEopkbeeZgMfKSFMKSHnjJIT2lA0nu/KQa01ZsyEOWccX+FFVeOZu4fwDxrMm0ASowc+AAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"gitlab pipeline","title":"gitlab pipeline","src":"/static/21a745cd322d080bd16b77635cf63dcc/a8200/gitlab_pipeline.png","srcSet":["/static/21a745cd322d080bd16b77635cf63dcc/52d5c/gitlab_pipeline.png 175w","/static/21a745cd322d080bd16b77635cf63dcc/1bae2/gitlab_pipeline.png 350w","/static/21a745cd322d080bd16b77635cf63dcc/a8200/gitlab_pipeline.png 700w","/static/21a745cd322d080bd16b77635cf63dcc/0ab52/gitlab_pipeline.png 1050w","/static/21a745cd322d080bd16b77635cf63dcc/fa92b/gitlab_pipeline.png 1400w","/static/21a745cd322d080bd16b77635cf63dcc/337cb/gitlab_pipeline.png 2030w"],"sizes":["(max-width:","700px)","100vw,","700px"],"loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Une fois les tests passés sur Gitlab et l'app déployée sur Heroku, migrez la base de prod :"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ heroku run upgrade --app votre_nom_app"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://votre_nom_app.herokuapp.com"},"children":[{"type":"text","value":"https://votre_nom_app.herokuapp.com"}]},{"type":"text","value":" est en prod et fonctionnelle!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rock 'n roll 🤘"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Prochain article ? Pourquoi ne pas pousser plus loin Heroku avec un peu de "},{"type":"element","tagName":"a","properties":{"href":"https://travis-ci.org/"},"children":[{"type":"text","value":"Travis CI"}]},{"type":"text","value":" pour varier les plaisirs ou tester les "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/features/actions"},"children":[{"type":"text","value":"Github Actions"}]},{"type":"text","value":" !"}]}],"data":{"quirksMode":false}}},"tagRef":{"edges":[{"node":{"fields":{"slug":"/api-flask-cicd-heroku"},"frontmatter":{"tags":["Python"],"title":"How do you do, fellow kids?","author":"Matthieu","excerpt":"Mettre en production rapidement une API Flask avec Gitlab et Heroku","date":"06/11/2019"}}}]},"infoAuthor":{"edges":[{"node":{"frontmatter":{"title":"Co-fondateur de Coddity","author":"Matthieu","date":"2017-01-01","excerpt":"L'important c'est les valeurs","illustration":{"childImageSharp":{"resize":{"src":"/static/31a741f3aa1a9535af13ff9bed969434/28898/cover.png"}}}},"fields":{"slug":"/matthieu"}}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/api-flask-cicd-heroku","tags":["Python"],"author":"Matthieu"}}}